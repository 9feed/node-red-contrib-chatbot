<script type="text/javascript">

  $.RedBot.registerType('chatbot-poll',{
    category: $.RedBot.config.name,
    color: '#FFCC66',
    defaults: {
      question: {
        value: '',
        required: true
      },
      allowMultipleAnswers: {
        value: false
      },
      pollType: {
        value: 'regular'
      },
      correctOptionId: {
        value: null
      },
      options: {
        value: []
      }
    },
    inputs: 1,
    outputs: 1,
    icon: 'chatbot-listen-lexicon.png',
    paletteLabel: 'Poll',
    label: function() {
      return 'Poll';
    },
    oneditsave: function() {
      var domRules = $('#node-input-values-container').editableList('items');
      var node = this;
      var idx;
      // init
      node.options = [];
      node.pollType = $('#node-config-pollType').val();
      // store terms, all lowercase
      for(idx = 0; idx < domRules.length; idx++) {
        var selector = domRules[idx].find('input');
        node.options.push(selector.val().toLowerCase());
      }
    },
    oneditprepare: function() { 
      $('#node-input-values-container')
        .css('min-width', '450px')
        .editableList({
          addButton: 'Add option',
          addItem: function(container, i, entity) {
            var value = typeof entity == 'object' ? '' : entity;
            var row = $('<div/>').appendTo(container);
            $('<input/>', {
                style: 'width:100%',
                class: 'node-input-option-value',
                type: 'text',
                value: value
              }).appendTo(row);
          },
          removable: true,
          sortable: true
        });
      var options = this.options || [];
      // populate the control
      var idx;
      for (idx = 0; idx < options.length; idx++) {
        $("#node-input-values-container").editableList('addItem', options[idx]);
      }
      console.log('poll', this.pollType)
      console.log(this.pollType)
      console.log(this)
      // hide correct answer
      if (this.pollType == 'regular') {      
        $('.form-row-correctOptionId').hide();
      }
      $('#node-config-pollType')
        .change(function() {
          var pollType = $(this).val();
          if (pollType === 'regular') {            
            $('.form-row-correctOptionId').hide();        
          } else {
            $('.form-row-correctOptionId').show();
          }
        });
    },
    oneditresize: function() {
      var dialogForm = $('#dialog-form');
      var rowQuestion = $('.form-row-question', dialogForm);
      var rowAllowMultipleAnswers = $('.form-row-allowMultipleAnswers', dialogForm);
      var rowPollType = $('.form-row-pollType', dialogForm);
      var rowCorrectOptionId = $('.form-row-correctOptionId', dialogForm);
      var rowLabel = $('.form-row-label', dialogForm);
      
      var height = dialogForm.height() 
        - rowQuestion.height() 
        - rowAllowMultipleAnswers.height() 
        - rowPollType.height() 
        - rowCorrectOptionId.height() 
        - rowLabel.height() - 30;
      $('#node-input-values-container').editableList('height', height);
    }
  });
</script>


<script type="text/x-red" data-template-name="chatbot-poll">
<div class="form-row form-row-question">
  <label for="node-input-question">Question</label>
  <input type="text" id="node-input-question" placeholder="Poll Question">
</div>
<div class="form-row form-row-allowMultipleAnswers">
  <label for="node-config-input-allowMultipleAnswers" style="width:auto;">Multiple Answers</label>
  <input type="checkbox" value="true" id="node-config-input-allowMultipleAnswers" style="margin-top:0px;">
</div>
<div class="form-row form-row-pollType">
  <label for="node-config-pollType">Poll type</label>
  <select id="node-config-pollType" placeholder="Select poll type">
    <option value="regular">Regular</option>
    <option value="quiz">Quiz</option>
  </select>
</div>
<div class="form-row form-row-correctOptionId">
  <label for="node-input-correctOptionId">Correct Answer</label>
  <input type="number" style="width:150px;" id="node-input-correctOptionId" placeholder="Correct answer number">
</div>
<div class="form-row form-row-label" style="margin-bottom:0;">
  <label style="width:100%;"><i class="fa fa-list"></i> <span>Options</span></label>
</div>
<div class="form-row node-input-values-container-row">
  <ol id="node-input-values-container"></ol>
</div>
</script>

<script type="text/x-red" data-help-name="chatbot-poll">
</script>
